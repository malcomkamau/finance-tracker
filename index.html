<!DOCTYPE html>
<html>
  <head>
    <title>Finance Tracker</title>
    <style>
      body {
        font-family: Arial;
        margin: 2rem;
      }
      table,
      th,
      td {
        border: 1px solid #ccc;
        border-collapse: collapse;
        padding: 0.5rem;
      }
      th {
        background-color: #f2f2f2;
      }
      input,
      select {
        margin: 0.5rem 0;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  </head>
  <body>
    <h2>Add Transaction</h2>
    <form id="transactionForm">
      <input type="date" name="Date" required /><br />
      <input
        type="text"
        name="Item Name"
        placeholder="Item Name"
        required
      /><br />
      <input
        type="text"
        name="Category"
        placeholder="Category"
        required
      /><br />
      <input
        type="number"
        name="Quantity"
        placeholder="Quantity"
        required
      /><br />
      <input
        type="number"
        name="Price Per Unit"
        placeholder="Price Per Unit"
        step="0.01"
        required
      /><br />
      <input type="text" name="Vendor" placeholder="Vendor" /><br />
      <input
        type="text"
        name="Payment Method"
        placeholder="Payment Method"
      /><br />
      <input type="text" name="Notes" placeholder="Notes" /><br />
      <button type="submit">Submit</button>
    </form>

    <h3>Filter Transactions</h3>
    <div id="filters">
      <input
        type="text"
        id="searchText"
        placeholder="Search by item/vendor/category"
      />
      <input type="date" id="startDate" />
      <input type="date" id="endDate" />
      <select id="categoryFilter">
        <option value="">All Categories</option>
        <!-- Dynamically filled -->
      </select>
      <button onclick="applyFilters()">Apply Filters</button>
      <button onclick="resetFilters()">Reset</button>
    </div>

    <h3>Spending by Category</h3>
    <canvas id="categoryChart" width="600" height="300"></canvas>

    <h3>Spending Over Time</h3>
    <canvas id="timeChart" width="600" height="300"></canvas>

    <h3>Export Options</h3>
    <button onclick="exportToCSV()">Export CSV</button>
    <button onclick="exportToPDF()">Export PDF</button>

    <h2>Transaction List</h2>
    <table id="transactionTable">
      <thead></thead>
      <tbody></tbody>
    </table>

    <script>
      const BASE_URL = "https://finance-tracker-97jz.onrender.com";

      // Submit form
      document
        .getElementById("transactionForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const data = Object.fromEntries(new FormData(form));
          data["Quantity"] = parseFloat(data["Quantity"]);
          data["Price Per Unit"] = parseFloat(data["Price Per Unit"]);

          await fetch(`${BASE_URL}/api/submit`, {
            // <-- POST via local server
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          form.reset();
          loadTransactions();
        });

      // Load transactions into table
      let fullData = []; // Global data

      async function loadTransactions() {
        try {
          const res = await fetch(`${BASE_URL}/api/data`);
          const data = await res.json();

          fullData = data; // Save full data for filtering

          populateCategoryFilter(data);
          displayTable(data); // Show all by default
          updateCharts(data);
        } catch (err) {
          console.error("Failed to fetch data:", err);
        }
      }

      function displayTable(data) {
        const thead = document.querySelector("#transactionTable thead");
        const tbody = document.querySelector("#transactionTable tbody");
        thead.innerHTML = "";
        tbody.innerHTML = "";

        if (data.length === 0) return;

        const headerRow = document.createElement("tr");
        Object.keys(data[0]).forEach((key) => {
          const th = document.createElement("th");
          th.textContent = key;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        data.forEach((row) => {
          const tr = document.createElement("tr");
          Object.values(row).forEach((value) => {
            const td = document.createElement("td");
            td.textContent = value;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }

      function applyFilters() {
        const searchText = document
          .getElementById("searchText")
          .value.toLowerCase();
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const category = document.getElementById("categoryFilter").value;

        const filtered = fullData.filter((tx) => {
          const date = tx.Date || "";
          const item = tx["Item Name"]?.toLowerCase() || "";
          const vendor = tx["Vendor"]?.toLowerCase() || "";
          const cat = tx["Category"]?.toLowerCase() || "";

          const matchesSearch =
            item.includes(searchText) ||
            vendor.includes(searchText) ||
            cat.includes(searchText);

          const matchesCategory = !category || tx["Category"] === category;
          const matchesStart = !startDate || date >= startDate;
          const matchesEnd = !endDate || date <= endDate;

          return matchesSearch && matchesCategory && matchesStart && matchesEnd;
        });

        displayTable(filtered);
        updateCharts(filtered);
      }

      function resetFilters() {
        document.getElementById("searchText").value = "";
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
        document.getElementById("categoryFilter").value = "";
        displayTable(fullData);
      }

      function populateCategoryFilter(data) {
        const select = document.getElementById("categoryFilter");
        const categories = [...new Set(data.map((tx) => tx.Category))];
        select.innerHTML = '<option value="">All Categories</option>';
        categories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          select.appendChild(option);
        });
      }

      let categoryChart, timeChart;

      function updateCharts(data) {
        // --- Group by category ---
        const categoryTotals = {};
        data.forEach((tx) => {
          const cat = tx.Category;
          const total =
            (parseFloat(tx["Quantity"]) || 0) *
            (parseFloat(tx["Price Per Unit"]) || 0);
          categoryTotals[cat] = (categoryTotals[cat] || 0) + total;
        });

        function exportToCSV() {
          const rows = document.querySelectorAll("#transactionTable tr");
          if (rows.length === 0) return;

          let csvContent = "";
          rows.forEach((row) => {
            const cols = row.querySelectorAll("td, th");
            const line = Array.from(cols)
              .map((td) => `"${td.textContent}"`)
              .join(",");
            csvContent += line + "\n";
          });

          const blob = new Blob([csvContent], { type: "text/csv" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = "transactions.csv";
          a.click();
          URL.revokeObjectURL(url);
        }

        async function exportToPDF() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          const table = document.getElementById("transactionTable");
          const rows = table.querySelectorAll("tr");

          if (rows.length === 0) return;

          const headers = Array.from(rows[0].querySelectorAll("th")).map(
            (th) => th.textContent
          );
          const data = Array.from(rows)
            .slice(1)
            .map((tr) =>
              Array.from(tr.querySelectorAll("td")).map((td) => td.textContent)
            );

          doc.text("Finance Transactions", 14, 14);
          doc.autoTable({
            startY: 20,
            head: [headers],
            body: data,
          });

          doc.save("transactions.pdf");
        }

        const catLabels = Object.keys(categoryTotals);
        const catValues = Object.values(categoryTotals);

        // Destroy previous chart if exists
        if (categoryChart) categoryChart.destroy();
        categoryChart = new Chart(document.getElementById("categoryChart"), {
          type: "bar",
          data: {
            labels: catLabels,
            datasets: [
              {
                label: "Total Spending",
                data: catValues,
                backgroundColor: "rgba(75, 192, 192, 0.6)",
              },
            ],
          },
        });

        // --- Group by date ---
        const dateTotals = {};
        data.forEach((tx) => {
          const date = tx.Date;
          const total =
            (parseFloat(tx["Quantity"]) || 0) *
            (parseFloat(tx["Price Per Unit"]) || 0);
          dateTotals[date] = (dateTotals[date] || 0) + total;
        });

        const sortedDates = Object.keys(dateTotals).sort();
        const dateValues = sortedDates.map((date) => dateTotals[date]);

        if (timeChart) timeChart.destroy();
        timeChart = new Chart(document.getElementById("timeChart"), {
          type: "line",
          data: {
            labels: sortedDates,
            datasets: [
              {
                label: "Spending Over Time",
                data: dateValues,
                borderColor: "rgba(153, 102, 255, 0.8)",
                fill: false,
                tension: 0.2,
              },
            ],
          },
        });
      }

      loadTransactions(); // Initial load
    </script>
  </body>
</html>
